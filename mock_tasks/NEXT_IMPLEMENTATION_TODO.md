# 次回実装TODO - EnDance打ち合わせフィードバック対応

**作成日**: 2025-10-27
**ステータス**: 着手順番決定済み

---

## 🎯 次回着手順番（推奨）

### 【第1優先】Step 1: ダッシュボード指標修正（簡単・即時効果）
**所要時間**: 30分
**難易度**: ⭐
**ファイル**: `Dashboard.tsx`

```typescript
変更内容:
✅ ❌削除: アクティブ会員数
✅ ✅追加: 幽霊会員数（最終来店から○日経過の会員）
✅ ✅変更: 期間表示を「今月（1日〜末日）」に統一
✅ ✅維持: 総会員数、新規入会数
```

**実装詳細**:
- KPIカードから「アクティブ会員数」を削除
- 新しいKPIカード「幽霊会員数」を追加
  - 定義: 最終来店日から30日以上経過
  - 色: warning（オレンジ）
  - アイコン: AlertCircle
- 日付フィルタを「今月」デフォルトに変更

---

### 【第2優先】Step 2: 生徒管理のスクリーニング機能（データ抽出の要望）
**所要時間**: 2時間
**難易度**: ⭐⭐
**ファイル**: `MemberManagement.tsx`

```typescript
追加機能:
✅ 高度フィルタパネル
  - 最終来店日範囲指定
  - 会員ステータス（アクティブ/幽霊/退会）
  - 月謝タイプ（受け放題/チケット制/月謝固定）
  - 登録日範囲
  - 店舗別
✅ 幽霊会員自動検出フィルタ（ワンクリック）
✅ フィルタ保存機能（よく使う条件を保存）
✅ CSV出力機能（フィルタ結果のみ出力）
```

**実装詳細**:
- フィルタパネルをアコーディオンで追加
- 条件を組み合わせた高度な検索
- 「幽霊会員のみ」クイックフィルタボタン
- CSV出力ボタン（react-csvまたはjson2csv使用）

---

### 【第3優先】Step 3: 出席管理の全面改修（最重要・最も複雑）
**所要時間**: 8時間
**難易度**: ⭐⭐⭐⭐
**ファイル**: `AttendanceManagement.tsx`

#### 3-1. ビューの変更

```typescript
現在: 日次リストビュー
↓
変更後: 週次カレンダービュー（プロモーション戦略用）

目的: 「弱いところ（生徒が少ない時間帯）」を可視化
```

**UIイメージ**:
```
┌─────────────────────────────────────────┐
│ 週選択: ← [10/21 - 10/27] →           │
│ 表示上限: [100人▾] [50人] [カスタム]   │
└─────────────────────────────────────────┘
┌───────┬───────┬───────┬───────┬───────┐
│ 月 21  │ 火 22 │ 水 23 │ 木 24 │ 金 25 │
├───────┼───────┼───────┼───────┼───────┤
│ 10:00 │ 10:00 │ 10:00 │ 10:00 │ 10:00 │
│ 15/30 │ 12/30 │ 8/30  │ 20/30 │ 18/30 │
│ [●●●] │ [●●  ]│ [●   ]│ [●●●●]│ [●●●] │
├───────┼───────┼───────┼───────┼───────┤
│ 14:00 │ 14:00 │ 14:00 │ 14:00 │ 14:00 │
│ 5/25  │ 4/25  │ 6/25  │ 7/25  │ 3/25  │
│ [●   ]│ [●   ]│ [●   ]│ [●   ]│ [    ]│
└───────┴───────┴───────┴───────┴───────┘

凡例: ●●●● = 80-100% / ●●● = 60-80% / ●● = 40-60% / ● = 20-40% / 空 = 0-20%
```

#### 3-2. チケット管理機能

```typescript
追加機能:
✅ 会員タイプ別出席処理
  1. 受け放題会員:
     - 「受ける/受けない」の手動入力UI
     - 予約システムとの連携（将来的）

  2. チケット制会員:
     - チェックイン時の自動チケット減算
     - 残チケット数リアルタイム表示
     - 連続クラスチェックイン機能（A先生→B先生）
       例: 18:00 HipHop → 19:30 Jazz を連続チェックイン
     - スマホ非保有者の代理チェックイン
       → スタッフが会員IDで検索してチェックイン

✅ チケット操作権限
  - チケット付与（月謝ページから）
  - チケット消費の取り消し（誤チェックイン対応）
  - 操作履歴の記録
```

**データ構造**:
```typescript
interface MemberTicket {
  memberId: string;
  ticketType: 'single' | 'package_10' | 'package_20' | 'unlimited';
  remainingTickets: number;
  expiryDate: Date;
}

interface CheckInRecord {
  id: string;
  memberId: string;
  lessonId: string;
  checkInTime: Date;
  ticketConsumed: boolean;
  consumedTicketId?: string;
  checkedInBy: 'member' | 'staff'; // 本人 or スタッフ代理
  staffId?: string; // スタッフ代理の場合
  cancelledAt?: Date;
  cancelledBy?: string;
}
```

#### 3-3. UI実装詳細

```typescript
// チェックインダイアログ
<Modal title="チェックイン">
  <div>
    <p>会員: 田中花子 (EN-2024-001)</p>
    <p>残チケット: 8枚</p>
    <p>レッスン: 18:00 HipHop初級（山田先生）</p>

    {/* 連続クラスオプション */}
    <Checkbox>
      次のクラスもチェックイン
      19:30 Jazz中級（佐藤先生）
      消費チケット: 2枚
    </Checkbox>

    <Button>チェックイン実行</Button>
  </div>
</Modal>

// 取り消しボタン
<Button variant="danger" size="sm">
  チェックイン取り消し
</Button>
```

---

### 【第4優先】Step 4: レッスン管理の代行管理機能（給与計算に必要）
**所要時間**: 4時間
**難易度**: ⭐⭐⭐
**ファイル**: `LessonManagement.tsx`

```typescript
追加機能:
✅ レギュラー講師 vs 代行講師の明示
✅ 代行履歴の詳細表示
  - いつ: 代行依頼日時
  - 誰から誰へ: レギュラー講師 → 代行講師
  - 理由: （任意入力）
✅ 代行カバー率の計算と表示
  公式: 代行カバー率 = (代行実施回数 / 代行依頼回数) × 100%
✅ 代行カバー率クリック → CSV詳細出力
✅ 給与計算用データの整形
```

**UIイメージ**:
```
レッスン一覧
┌─────────────────────────────────────────────────────┐
│ 18:00 HipHop初級                                     │
│ レギュラー: 山田太郎                                  │
│ 代行: 佐藤花子 (10/15依頼 → 10/16承認)              │
│ 代行カバー率: 85% [CSV出力]                          │
└─────────────────────────────────────────────────────┘
```

**CSV出力内容**:
```csv
レッスンID,日時,レギュラー講師,代行講師,依頼日,承認日,理由,給与区分
L001,2025-10-15 18:00,山田太郎,佐藤花子,2025-10-10,2025-10-11,家族の用事,代行
L002,2025-10-22 18:00,山田太郎,(代行なし),,,,-
```

---

### 【第5優先】Step 5: 権限・ロール管理システムの設計
**所要時間**: 6時間
**難易度**: ⭐⭐⭐⭐
**新規ファイル**: `Settings.tsx` 内に権限管理セクション追加

```typescript
ロール定義:
1. 社長（経営戦略部）
   - 全データ閲覧
   - 経営分析レポート
   - 全店舗の売上・利益データ

2. 経理部
   - 売上・支払いデータ
   - 給与計算データ
   - 会計帳簿

3. 店長
   - 担当店舗の全データ
   - スタッフ管理
   - 出席管理
   - 生徒管理

4. 現場スタッフ
   - 出席管理（チェックイン）
   - 会員情報閲覧（個人情報除く）
   - レッスンスケジュール

5. 外部委託（経理）
   - 売上データ（閲覧のみ）
   - 請求書データ
```

**実装**:
- ロール管理UI（ドラッグ＆ドロップで権限割り当て）
- 権限マトリックス表示
- ロール別のサイドバーフィルタ（見えないメニューは非表示）

---

### 【第6優先】Step 6: 複数店舗管理機能の強化
**所要時間**: 3時間
**難易度**: ⭐⭐
**ファイル**: `Header.tsx`, 各画面

```typescript
追加機能:
✅ ヘッダーに店舗選択ドロップダウン
  - 渋谷
  - 横浜
  - 群馬
  - 全店舗統合ビュー

✅ 店舗間連携データ
  - 渋谷⇔横浜の会員移動トラッキング
  - クロスユース会員の識別

✅ 店舗別フィルタリング
  - ダッシュボード
  - 売上集計
  - 生徒管理
```

---

### 【第7優先】Step 7: 講師管理とスタッフ管理の完全分離
**所要時間**: 2時間
**難易度**: ⭐⭐
**ファイル**: `InstructorManagement.tsx`, `StaffManagement.tsx`

```typescript
現在: 混在している可能性
↓
変更後: 完全分離

InstructorManagement.tsx (講師管理):
- レギュラー枠の管理
- 代行履歴
- 給与計算データ
- レッスンスキル・得意ジャンル

StaffManagement.tsx (スタッフ管理):
- 受付・事務スタッフ
- シフト管理
- 店舗別配置
- 勤怠管理
```

**注意点**:
- 2012年以前は講師兼スタッフがいたため、過去データの扱いに注意
- 兼任フラグを持たせるか検討

---

## 📊 作業時間見積もり

| Step | 作業内容 | 所要時間 | 難易度 |
|------|---------|---------|--------|
| 1 | ダッシュボード指標修正 | 30分 | ⭐ |
| 2 | 生徒管理スクリーニング | 2時間 | ⭐⭐ |
| 3 | 出席管理全面改修 | 8時間 | ⭐⭐⭐⭐ |
| 4 | レッスン代行管理 | 4時間 | ⭐⭐⭐ |
| 5 | 権限・ロール管理 | 6時間 | ⭐⭐⭐⭐ |
| 6 | 複数店舗管理 | 3時間 | ⭐⭐ |
| 7 | 講師/スタッフ分離 | 2時間 | ⭐⭐ |
| **合計** | | **25.5時間** | |

---

## 🚀 着手推奨スケジュール

### セッション1（2-3時間）
- ✅ Step 1: ダッシュボード修正（30分）
- ✅ Step 2: 生徒管理スクリーニング（2時間）

### セッション2（4時間）
- ✅ Step 3-1: 出席管理ビュー変更（週次カレンダー実装）

### セッション3（4時間）
- ✅ Step 3-2: 出席管理チケット機能実装

### セッション4（4時間）
- ✅ Step 4: レッスン代行管理
- ✅ Step 7: 講師/スタッフ分離

### セッション5（6時間）
- ✅ Step 5: 権限・ロール管理

### セッション6（3時間）
- ✅ Step 6: 複数店舗管理

---

## 📝 技術的な注意事項

### チケット管理のデータベース設計

```typescript
// 新規テーブル案
memberTickets {
  id: uuid
  memberId: uuid
  ticketType: enum
  remainingTickets: int
  totalTickets: int
  purchaseDate: timestamp
  expiryDate: timestamp
}

ticketUsageHistory {
  id: uuid
  memberId: uuid
  ticketId: uuid
  lessonId: uuid
  consumedAt: timestamp
  consumedBy: uuid (staff or member)
  cancelled: boolean
  cancelledAt: timestamp
  cancelledBy: uuid
}
```

### 週次カレンダーのライブラリ選定

推奨: `react-big-calendar` または `@fullcalendar/react`

```bash
npm install react-big-calendar date-fns
```

### CSV出力のライブラリ

推奨: `react-csv` または `json2csv`

```bash
npm install react-csv
```

---

## 🎯 最優先アクションアイテム（次回セッション開始時）

1. ✅ **ダッシュボードの幽霊会員数追加**（即効性高い）
2. ✅ **生徒管理のCSV出力機能**（データ抽出ニーズが高い）
3. ✅ **出席管理の週次ビュー設計**（プロモーション戦略の要）

---

## 📌 備考

- 打ち合わせで明確になった要望を優先順位付け
- データ構造の変更が必要な項目は事前にスキーマ設計を確認
- 給与計算との連携は外部システムとのI/F設計も必要
- ロール管理は将来的なマルチテナント対応の基盤になる

**次回着手時はこのファイルを参照して進めてください。**
